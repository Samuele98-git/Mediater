<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Player</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        /* TOP BAR */
        .header { padding: 15px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .back-btn { color: #aaa; text-decoration: none; font-weight: bold; }
        
        /* PLAYER AREA (Fixed Height) */
        .stage { flex: 0 0 auto; width: 100%; max-height: 60vh; background: #000; display: flex; justify-content: center; border-bottom: 1px solid #333; }
        .cinema-box { width: 100%; max-width: 1000px; aspect-ratio: 16/9; position: relative; }
        video, img { width: 100%; height: 100%; object-fit: contain; }

        /* PLAYLIST BELOW (Scrollable) */
        .playlist-area { flex: 1; overflow-y: auto; padding: 20px; background: #141414; }
        .playlist-container { max-width: 800px; margin: 0 auto; }
        .list-header { margin-bottom: 15px; color: #777; font-weight: bold; }
        
        .list-item { display: flex; gap: 15px; padding: 10px; background: #1f1f1f; margin-bottom: 5px; cursor: pointer; border-radius: 4px; border: 1px solid transparent; }
        .list-item:hover { background: #2a2a2a; }
        .list-item.active { border-color: var(--red); background: #222; }
        
        .thumb { width: 100px; height: 56px; background: #000; object-fit: cover; }
        .info { display: flex; flex-direction: column; justify-content: center; }
        .title { font-weight: bold; font-size: 0.9rem; }
        
        :root { --red: #e50914; }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn">‚Üê Back to Library</a>
        <div id="plName">Playlist</div>
    </div>

    <div class="stage">
        <div class="cinema-box">
            <video id="vid" controls autoplay style="display:none"></video>
            <img id="img" style="display:none">
        </div>
    </div>

    <div class="playlist-area">
        <div class="playlist-container">
            <div class="list-header">Up Next</div>
            <div id="list"></div>
        </div>
    </div>

    <script>
        const p = new URLSearchParams(location.search);
        let plIdx = parseInt(p.get('pl'));
        let vidIdx = parseInt(p.get('vid'));
        let playlist = [];

        window.onload = async () => {
            const res = await fetch('/api/data');
            const data = await res.json();
            const pl = data.playlists[plIdx];
            playlist = pl.videos;
            document.getElementById('plName').innerText = pl.name;
            play(vidIdx);
            renderList();
        };

        function play(idx) {
            vidIdx = idx;
            const file = playlist[idx];
            
            // Update Player
            const vid = document.getElementById('vid');
            const img = document.getElementById('img');
            const isVid = file.match(/\.(mp4|mkv|mov)$/i);
            
            vid.style.display = 'none'; img.style.display = 'none';
            if(isVid) {
                vid.style.display = 'block'; vid.src = `/stream/${file}`; vid.play();
                vid.onended = () => play(idx + 1); // Auto-next
            } else {
                img.style.display = 'block'; img.src = `/stream/${file}`;
            }

            renderList(); // Update Highlight
        }

        function renderList() {
            const list = document.getElementById('list');
            list.innerHTML = '';
            
            playlist.forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = `list-item ${idx === vidIdx ? 'active' : ''}`;
                item.onclick = () => play(idx);

                const isVid = file.match(/\.(mp4|mkv|mov)$/i);
                const thumb = isVid ? `<video src="/stream/${file}#t=5.0" class="thumb" muted></video>` : `<img src="/stream/${file}" class="thumb">`;

                item.innerHTML = `
                    ${thumb}
                    <div class="info">
                        <div class="title">${idx+1}. ${file}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
    </script>
</body>
</html>